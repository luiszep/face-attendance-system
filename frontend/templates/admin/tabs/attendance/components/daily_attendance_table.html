<!-- Daily Attendance Table View -->
{# Use real data from backend #}
{% set attendance_data = attendance_data or [] %}
{% set absent_employees = absent_employees or [] %}
{% set selected_date = selected_date or 'Today' %}

<div class="bg-gray-900 rounded-2xl shadow-2xl border border-cyan-500/30 p-6 mb-6">
  <h1 class="text-3xl font-bold text-cyan-400 mb-2">Daily Attendance Results</h1>
  <p class="text-gray-300">{{ selected_date }} - Showing {{ (attendance_data|length + absent_employees|length) }} employees</p>
</div>

<!-- Attendance Table Container -->
<div id="attendance-cards-container" class="bg-gray-900 rounded-2xl shadow-2xl border border-cyan-500/30 overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-gray-800 border-b border-cyan-500/30">
          <th class="sticky left-0 z-10 bg-gray-800 px-6 py-3 text-left text-xs font-medium text-cyan-400 uppercase tracking-wider">Employee</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-cyan-400 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-cyan-400 uppercase tracking-wider">Occupation</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">First In</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">Last Out</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">Total Hours</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">Sessions</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-cyan-400 uppercase tracking-wider">Details</th>
        </tr>
      </thead>
      <tbody class="bg-gray-900 divide-y divide-gray-700">
        <!-- Present Employees -->
        {% for employee in attendance_data %}
          {% set has_incomplete = false %}
          {% set current_pair = [] %}
          {% for entry in employee.time_entries %}
            {% if entry.entry_type == 'check_in' %}
              {% set _ = current_pair.append(entry) %}
            {% elif entry.entry_type == 'check_out' and current_pair %}
              {% set _ = current_pair.clear() %}
            {% endif %}
          {% endfor %}
          {% if current_pair %}
            {% set has_incomplete = true %}
          {% endif %}
          
          <tr class="attendance-card hover:bg-gray-800/50 transition-colors" 
              data-status="present" 
              data-incomplete="{{ 'true' if has_incomplete else 'false' }}" 
              data-reg-id="{{ employee.reg_id }}"
              data-name="{{ employee.first_name }} {{ employee.last_name }}"
              data-occupation="{{ employee.occupation }}">
            <td class="sticky left-0 z-10 bg-gray-900 hover:bg-gray-800/50 px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8">
                  <div class="h-8 w-8 bg-cyan-500 rounded-full flex items-center justify-center text-xs font-bold text-black">
                    {{ employee.first_name[0] }}{{ employee.last_name[0] }}
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-white">{{ employee.last_name }}, {{ employee.first_name }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ employee.reg_id }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ employee.occupation }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              {% if has_incomplete %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-900/20 text-yellow-400 border border-yellow-500/30">
                  Incomplete
                </span>
              {% else %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-900/20 text-green-400 border border-green-500/30">
                  Complete
                </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-white">{{ employee.start_time }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-white">{{ employee.end_time }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-cyan-400">{{ employee.total_hours }}h</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-300">
              {% set checkout_count = employee.time_entries | selectattr('entry_type', 'equalto', 'check_out') | list | length %}
              {{ checkout_count }} session{{ 's' if checkout_count != 1 else '' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <button onclick="toggleDetails('{{ employee.reg_id }}')" class="text-cyan-400 hover:text-cyan-300 text-sm font-medium">
                View
              </button>
            </td>
          </tr>
          
          <!-- Expandable Details Row (hidden by default) -->
          <tr id="details-{{ employee.reg_id }}" class="hidden bg-gray-800/30">
            <td colspan="9" class="px-6 py-4">
              <div class="pl-14">
                <div class="text-xs font-medium text-gray-400 mb-2">Check-in/out Timeline:</div>
                <div class="flex flex-wrap gap-2">
                  {% set current_pair = [] %}
                  {% for entry in employee.time_entries %}
                    {% if entry.entry_type == 'check_in' %}
                      {% set _ = current_pair.append(entry) %}
                    {% elif entry.entry_type == 'check_out' and current_pair %}
                      {% set check_in = current_pair[0] %}
                      <div class="bg-gray-700 rounded px-2 py-1 text-xs">
                        <span class="text-green-400">IN:</span> {{ check_in.timestamp.split(' ')[1][:5] }}
                        <span class="text-gray-500 mx-1">â†’</span>
                        <span class="text-red-400">OUT:</span> {{ entry.timestamp.split(' ')[1][:5] }}
                      </div>
                      {% set _ = current_pair.clear() %}
                    {% endif %}
                  {% endfor %}
                  {% if current_pair %}
                    <div class="bg-gray-700 rounded px-2 py-1 text-xs">
                      <span class="text-green-400">IN:</span> {{ current_pair[0].timestamp.split(' ')[1][:5] }}
                      <span class="text-yellow-400 ml-2">No checkout</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
        
        <!-- Absent Employees -->
        {% for employee in absent_employees %}
          <tr class="attendance-card hover:bg-gray-800/50 transition-colors" 
              data-status="absent" 
              data-incomplete="false" 
              data-reg-id="{{ employee.reg_id }}"
              data-name="{{ employee.first_name }} {{ employee.last_name }}"
              data-occupation="{{ employee.occupation }}"
              style="display: none;">
            <td class="sticky left-0 z-10 bg-gray-900 hover:bg-gray-800/50 px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8">
                  <div class="h-8 w-8 bg-red-500 rounded-full flex items-center justify-center text-xs font-bold text-white">
                    {{ employee.first_name[0] }}{{ employee.last_name[0] }}
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-white">{{ employee.last_name }}, {{ employee.first_name }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ employee.reg_id }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ employee.occupation }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-900/20 text-red-400 border border-red-500/30">
                Absent
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">0h</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-gray-500">-</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    
    {% if not attendance_data and not absent_employees %}
      <!-- No Results -->
      <div class="p-8 text-center">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">No Attendance Records Found</h3>
        <p class="text-gray-400">No employees match your search criteria for this date.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Details Toggle Script -->
<script>
function toggleDetails(regId) {
    const detailsRow = document.getElementById('details-' + regId);
    if (detailsRow) {
        detailsRow.classList.toggle('hidden');
    }
}
</script>
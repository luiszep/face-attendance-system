<!-- Employee Database Overview -->
<div class="max-w-7xl mx-auto bg-gray-900 rounded-2xl shadow-2xl border-4 border-green-400 neon-border p-8 mt-6">
  <!-- Header -->
  <div class="mb-8 text-center">
    <h1 class="text-4xl font-bold text-green-400 mb-4">Employee Database</h1>
    <p class="text-gray-300 text-lg">Overview of all registered employees in the system</p>
    <div class="mt-4 inline-flex items-center space-x-4 bg-gray-800 px-6 py-3 rounded-full border border-green-500/30 ">
      <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
      </svg>
      <span class="text-white font-semibold">Total Employees: {{ employees|length }}</span>
    </div>
  </div>

  {% if employees %}
    <!-- Employee Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      {% for employee in employees %}
        <!-- Employee Card -->
        <div class="bg-gray-800 rounded-xl shadow-lg border border-green-500/20 hover:border-green-400/50 transition-all duration-300 cursor-pointer transform hover:-translate-y-2 hover:shadow-xl  group"
             onclick="selectEmployee('{{ employee.regid }}')">
          
          <!-- Employee Photo -->
          <div class="relative">
            {% set employee_image = images|selectattr('employee.regid', 'equalto', employee.regid)|first %}
            {% if employee_image %}
              <img src="{{ employee_image.url }}" 
                   alt="{{ employee.first_name }} {{ employee.last_name }}" 
                   class="w-full h-48 object-cover rounded-t-xl">
            {% else %}
              <div class="w-full h-48 bg-gray-700 bg-opacity-50 rounded-t-xl flex items-center justify-center">
                <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
            {% endif %}
            
            <!-- Status Badge -->
            <div class="absolute top-2 right-2 bg-green-500 text-black text-xs px-2 py-1 rounded-full font-medium">
              Active
            </div>
          </div>

          <!-- Employee Info -->
          <div class="p-4">
            <h3 class="text-lg font-semibold text-white mb-1 group-hover:text-green-400 transition-colors">
              {{ employee.first_name }} {{ employee.last_name }}
            </h3>
            <p class="text-gray-400 text-sm mb-2">{{ employee.occupation }}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500 font-mono">ID: {{ employee.regid }}</span>
              <div class="text-green-400 opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Quick Actions -->
    <div class="mt-12">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
        <!-- Left: Action Buttons -->
        <div class="text-center md:text-left">
          <div class="space-y-4">
            <button onclick="showAddEmployeeForm()" 
                    class="inline-flex items-center px-6 py-3 bg-green-500 hover:bg-green-600 text-black font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 neon-border">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add New Employee
            </button>
            
            <button onclick="startEncodingGeneration()" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 ml-4">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Generate Encodings
            </button>
            
            <!-- Hidden form for actual submission -->
            <form id="encodingForm" action="{{ url_for('generate_encodings') }}" method="post" style="display: none;">
              <input type="hidden" name="generate" value="true">
            </form>
          </div>
        </div>
        
        <!-- Right: Help Text -->
        <div class="text-center md:text-right text-gray-400 text-sm space-y-2">
          <p><strong>💡 Tips:</strong></p>
          <p>• Click any employee card to view and edit details</p>
          <p>• Generate encodings after adding new employees</p>
          <p>• Encodings are required for facial recognition</p>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
      <div class="bg-gray-800 rounded-2xl shadow-lg p-12 border border-green-500/20  max-w-md mx-auto">
        <svg class="w-24 h-24 text-gray-400 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <h3 class="text-2xl font-bold text-white mb-4">No Employees Yet</h3>
        <p class="text-gray-400 mb-8">Get started by adding your first employee to the database.</p>
        <button onclick="showAddEmployeeForm()" 
                class="inline-flex items-center px-8 py-4 bg-green-500 hover:bg-green-600 text-black font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 neon-border">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add First Employee
        </button>
      </div>
    </div>
  {% endif %}
</div>

<!-- Encoding Generation Modal -->
<div id="encodingModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center">
  <div class="bg-gray-900 rounded-2xl shadow-2xl border-4 border-green-400 neon-border max-w-md w-full mx-4 p-8 text-center">
    <!-- Modal Header -->
    <div class="mb-6">
      <div class="bg-green-500/20 rounded-full p-4 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
        <svg id="encodingIcon" class="w-10 h-10 text-green-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">Generating Face Encodings</h3>
      <p class="text-gray-300">Please wait while we process your employee photos...</p>
    </div>

    <!-- Progress Information -->
    <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-green-500/20">
      <div class="space-y-4">
        <div class="flex items-center justify-center space-x-3">
          <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          <span class="text-white font-medium">Processing employee photos</span>
        </div>
        
        <!-- Progress Steps -->
        <div class="text-sm text-gray-400 space-y-2">
          <div class="progress-step flex items-center justify-between text-gray-300">
            <span>1. Downloading photos from cloud storage</span>
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div class="progress-step flex items-center justify-between text-gray-400">
            <span>2. Extracting facial features</span>
            <div class="w-4 h-4 border-2 border-green-400 border-t-transparent rounded-full animate-spin"></div>
          </div>
          <div class="progress-step flex items-center justify-between text-gray-500">
            <span>3. Generating encoding file</span>
            <div class="w-4 h-4 border-2 border-gray-500 rounded-full"></div>
          </div>
          <div class="progress-step flex items-center justify-between text-gray-500">
            <span>4. Uploading to secure storage</span>
            <div class="w-4 h-4 border-2 border-gray-500 rounded-full"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Warning Message -->
    <div class="bg-amber-900/30 border border-amber-500/30 rounded-lg p-4 mb-6">
      <div class="flex items-start space-x-3">
        <svg class="w-5 h-5 text-amber-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <div class="text-left">
          <p class="text-amber-300 font-medium text-sm">⚠️ Important: Do Not Close This Tab!</p>
          <p class="text-amber-200 text-xs mt-1">Closing this tab or navigating away will interrupt the encoding process and may corrupt the facial recognition data. This process is essential for the attendance system to work properly.</p>
        </div>
      </div>
    </div>

    <!-- Processing Time Info -->
    <div class="text-xs text-gray-500">
      <p>Typical processing time: 30 seconds - 2 minutes</p>
      <p>Time depends on number of employees and photo quality</p>
    </div>
  </div>
</div>

<script>
function selectEmployee(regid) {
  // Redirect to the employee detail view
  window.location.href = "{{ url_for('admin_bp.data') }}?edit_regid=" + regid;
}

function showAddEmployeeForm() {
  // Redirect to add new employee form
  window.location.href = "{{ url_for('admin_bp.data') }}?add_new=true";
}

// Encoding Generation Functionality
let isEncodingInProgress = false;

function startEncodingGeneration() {
  // Show confirmation dialog first
  if (!confirm('This will generate face encodings for all employees. The process may take 1-2 minutes. Are you sure you want to continue?')) {
    return;
  }
  
  // Set encoding in progress flag
  isEncodingInProgress = true;
  
  // Show the modal
  document.getElementById('encodingModal').classList.remove('hidden');
  
  // Prevent page closing/navigation
  setupPageProtection();
  
  // Start the animated progress simulation
  startProgressAnimation();
  
  // Submit the form to start actual encoding
  setTimeout(() => {
    document.getElementById('encodingForm').submit();
  }, 1000); // Small delay to ensure modal is visible
}

function setupPageProtection() {
  // Prevent back button
  history.pushState(null, null, location.href);
  window.addEventListener('popstate', function() {
    if (isEncodingInProgress) {
      history.pushState(null, null, location.href);
      // Show custom alert instead of browser dialog
      showCustomAlert('Encoding generation is in progress. Please wait for completion before navigating away.');
    }
  });
  
  // Disable all navigation elements during encoding
  disableNavigation();
}

function disableNavigation() {
  // Disable all links temporarily
  const links = document.querySelectorAll('a, button[onclick*="location"], button[onclick*="window"]');
  links.forEach(link => {
    if (link.onclick && !link.onclick.toString().includes('startEncodingGeneration')) {
      link.dataset.originalOnclick = link.onclick.toString();
      link.onclick = function(e) {
        e.preventDefault();
        showCustomAlert('Please wait for encoding generation to complete before navigating.');
        return false;
      };
    }
    if (link.href && !link.href.includes('javascript:')) {
      link.dataset.originalHref = link.href;
      link.href = 'javascript:void(0)';
      link.onclick = function(e) {
        e.preventDefault();
        showCustomAlert('Please wait for encoding generation to complete before navigating.');
        return false;
      };
    }
  });
  
  // Disable form submissions (except encoding form)
  const forms = document.querySelectorAll('form:not(#encodingForm)');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      if (isEncodingInProgress) {
        e.preventDefault();
        showCustomAlert('Please wait for encoding generation to complete before submitting forms.');
      }
    });
  });
}

function enableNavigation() {
  // Re-enable all links
  const links = document.querySelectorAll('a, button[onclick*="location"], button[onclick*="window"]');
  links.forEach(link => {
    if (link.dataset.originalOnclick) {
      link.onclick = new Function(link.dataset.originalOnclick);
      delete link.dataset.originalOnclick;
    }
    if (link.dataset.originalHref) {
      link.href = link.dataset.originalHref;
      link.onclick = null;
      delete link.dataset.originalHref;
    }
  });
}

function showCustomAlert(message) {
  // Create custom alert modal
  const alertModal = document.createElement('div');
  alertModal.id = 'customAlert';
  alertModal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center';
  alertModal.innerHTML = `
    <div class="bg-gray-900 rounded-2xl shadow-2xl border-4 border-amber-400 max-w-md w-full mx-4 p-6 text-center">
      <div class="bg-amber-500/20 rounded-full p-3 w-16 h-16 mx-auto mb-4 flex items-center justify-center">
        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-white mb-3">Please Wait</h3>
      <p class="text-gray-300 mb-6">${message}</p>
      <button onclick="closeCustomAlert()" class="bg-amber-500 hover:bg-amber-600 text-black px-6 py-2 rounded-full font-semibold transition-colors">
        OK
      </button>
    </div>
  `;
  
  document.body.appendChild(alertModal);
  
  // Auto-close after 3 seconds
  setTimeout(() => {
    closeCustomAlert();
  }, 3000);
}

function closeCustomAlert() {
  const alertModal = document.getElementById('customAlert');
  if (alertModal) {
    alertModal.remove();
  }
}

function startProgressAnimation() {
  const steps = [
    { selector: 'step1', delay: 500 },
    { selector: 'step2', delay: 2000 },
    { selector: 'step3', delay: 5000 },
    { selector: 'step4', delay: 8000 }
  ];
  
  // Simulate progress steps
  setTimeout(() => updateProgressStep(1), 500);
  setTimeout(() => updateProgressStep(2), 3000);
  setTimeout(() => updateProgressStep(3), 8000);
  setTimeout(() => updateProgressStep(4), 12000);
}

function updateProgressStep(step) {
  const steps = document.querySelectorAll('.progress-step');
  if (steps[step - 1]) {
    const spinner = steps[step - 1].querySelector('.animate-spin, .border-gray-500');
    const checkmark = steps[step - 1].querySelector('.w-4.h-4:last-child');
    
    if (spinner && checkmark) {
      // Replace spinner with checkmark
      spinner.outerHTML = `
        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      `;
      
      // Update text color
      steps[step - 1].classList.remove('text-gray-500');
      steps[step - 1].classList.add('text-gray-300');
    }
  }
  
  // Update next step if it exists
  if (step < 4 && steps[step]) {
    const nextSpinner = steps[step].querySelector('.border-gray-500');
    if (nextSpinner) {
      nextSpinner.classList.remove('border-gray-500');
      nextSpinner.classList.add('border-green-400', 'border-t-transparent', 'animate-spin');
    }
    steps[step].classList.remove('text-gray-500');
    steps[step].classList.add('text-gray-400');
  }
}

// Clean up on page load (in case of refresh during encoding)
window.addEventListener('load', function() {
  // Reset modal state
  document.getElementById('encodingModal').classList.add('hidden');
  isEncodingInProgress = false;
  
  // Re-enable navigation in case of page refresh during encoding
  enableNavigation();
});

// Handle encoding completion (this would be triggered by server response)
function completeEncoding(success = true) {
  isEncodingInProgress = false;
  
  // Re-enable navigation
  enableNavigation();
  
  // Update modal to show completion
  const modal = document.getElementById('encodingModal');
  const modalContent = modal.querySelector('.bg-gray-900');
  
  if (success) {
    modalContent.innerHTML = `
      <div class="text-center">
        <div class="bg-green-500/20 rounded-full p-4 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">Encodings Generated Successfully!</h3>
        <p class="text-gray-300 mb-6">Face recognition is now ready for all employees.</p>
        <button onclick="closeModal()" class="bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-full font-semibold transition-colors">
          Continue
        </button>
      </div>
    `;
  } else {
    modalContent.innerHTML = `
      <div class="text-center">
        <div class="bg-red-500/20 rounded-full p-4 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">Encoding Generation Failed</h3>
        <p class="text-gray-300 mb-6">Please try again or contact support if the problem persists.</p>
        <button onclick="closeModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full font-semibold transition-colors">
          Close
        </button>
      </div>
    `;
  }
  
  // Auto-close after 3 seconds
  setTimeout(() => {
    closeModal();
  }, 3000);
}

function closeModal() {
  document.getElementById('encodingModal').classList.add('hidden');
  // Refresh page to show updated status
  window.location.reload();
}
</script>